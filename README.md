# Logstash-Certificates
Simplify creation of Logstash SSL certificates.

## Setup Logstash with SSL:

1. Clone the repo
2. Make sure that you have downloaded elasticsearch and logstash
3. Set the environment vars

```
export ELASTICSEARCH_PATH="/path/to/elasticsearch/directory"
export LOGSTASH_PATH="/path/to/logstash/directory"

## the ip address of your machine(the ip address where logstash will run, this can be 0.0.0.0 if you are using logstash on your local machine. It can be set to your machines IP address, like 192.168.1.5.)
export IP_ADDRESS="ip address"

## the hostname of your machine(the qualified host like: www.google.com, where logstash will run, if it is running on a domain.)
export HOSTNAME="www.example.com"

## the port at which logstash will be running
export LOGSTASH_PORT=1443
```

4. Generate the certificates by running

```
./sh make_cert.sh
```

The commmand should create a directory called "ssl_certificates" under your logstash root director. It will contain two directories "host" and "ca". The host contains the client key and certificate. the "ca" directory contains the CA key and certificate.

5. Copy the logstash_ssl.conf file from the repo to the logstash/config directory. This file contains logstash configuration for a 'tcp' input.

```
cp ./logstash_ssl.conf $LOGSTASH_PATH/config/
```

6. Run the logstash server with the configuration file

```
# from logstash root directory
bin/logstash -f ./config/logstash_ssl.conf
```

THe server should boot without errors. If you got any errors, you did something wrong.

7. Check if ssl works, by running 

```
sh ./check_cert.sh
```

The last couple of line sof the output should be something like :

```
* Server certificate:
*  subject: CN=host
*  start date: Dec 25 08:03:03 2020 GMT
*  expire date: Dec 25 08:03:03 2023 GMT
*  subjectAltName: host "192.168.1.13" matched cert's IP address!
*  issuer: CN=Elastic Certificate Tool Autogenerated CA
*  SSL certificate verify ok.
> GET / HTTP/1.1
> Host: 192.168.1.13:1443
> User-Agent: curl/7.58.0
> Accept: */*
```
The important line is "SSL certificate verify ok." and the last line with "Accept: */*"

If you reached this point, any SSL client with the client key, client certificate and the CA certificate can now ship logs to logstash at port 1443. You can change this port in the logstash_ssl.conf file if you want to.
Note that you need to open this port to the outside world, on your machine, if you want to receive logs from the outside.


## Send Rails Logs to Logstash over SSL:

Check the ruby_ssl.rb file to see how to use a simple tcp socket to send logs to logstash using the certificates we created above.

